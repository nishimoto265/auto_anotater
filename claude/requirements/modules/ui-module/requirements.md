# UI モジュール要件

## 1. 概要
PyQt6/PySide6を使用したメインユーザーインターフェースモジュール。高速フレーム表示とBB操作を提供。

## 2. 機能要件

### 2.1 メイン画面レイアウト
```
┌─────────────────────┬─────────────────┐
│                     │ 現在選択中      │
│   フレーム表示      │ ID: [2] 行動:[sit] │
│   （ズーム対応）    ├─────────────────│
│   BB重ね合わせ表示  │ 個体ID選択      │
│                     │ [0][1][2][3][4] │
│                     │ [5][6]...[15]   │
│                     ├─────────────────│
│                     │ 行動選択        │
│                     │ [sit][stand]    │
│                     │ [milk][water]   │
│                     │ [food] [+追加]  │
├─────────────────────┼─────────────────│
│ナビゲーション       │ 現在フレームBB  │
│[◀][001/500][▶]     │ ☑ BB1: ID2-sit  │
│[BB変化フレーム移動] │ ☑ BB2: ID5-stand│
│                     │ [重複検知モード]│
│進捗: ████████░░ 80% │ [自動アノテーション]│
└─────────────────────┴─────────────────┘
```

### 2.2 フレーム表示機能
- **高速切り替え**: 50ms以下でのフレーム表示
- **ズーム**: マウスホイールでのズームイン/アウト
- **パン**: ドラッグでの画像移動
- **リサイズ**: ウィンドウサイズに合わせた画像フィット

### 2.3 BB（バウンディングボックス）操作
- **作成**: マウスドラッグでの矩形描画
- **選択**: BBクリックでの選択状態変更
- **編集**: コーナー/エッジドラッグでのリサイズ
- **移動**: BBドラッグでの位置変更
- **削除**: 選択後Sキーでの削除

### 2.4 ID・行動選択
- **個体ID**: 0-15の数値ID選択
- **行動ID**: カスタマイズ可能な行動ラベル
- **色分け**: ID別・行動別の色分け表示
- **一括変更**: 選択BB群の一括ID/行動変更

### 2.5 ナビゲーション
- **フレーム移動**: 前/次フレームボタン
- **直接移動**: フレーム番号入力でのジャンプ
- **変化検知**: BB数変化フレームへの移動
- **進捗表示**: 全体進捗のプログレスバー

## 3. 非機能要件

### 3.1 パフォーマンス
- **描画速度**: 16ms以下でのBB描画更新
- **応答性**: 100ms以内のUI操作応答
- **メモリ効率**: 画像キャッシュの効率的管理

### 3.2 ユーザビリティ
- **白黒デザイン**: モダンで視認性の高いデザイン
- **直感的操作**: 一般的なUIパターンの採用
- **アクセシビリティ**: キーボード操作対応

### 3.3 カスタマイズ性
- **テーマ**: ダーク/ライトテーマ切り替え
- **レイアウト**: パネルサイズの調整
- **ショートカット**: キーバインドのカスタマイズ

## 4. インターフェース

### 4.1 入力インターフェース
- **画像データ**: video-processing-moduleから
- **アノテーションデータ**: annotation-moduleから
- **設定データ**: 設定ファイルから

### 4.2 出力インターフェース
- **UI イベント**: 他モジュールへの操作通知
- **設定変更**: ユーザー設定の保存要求
- **状態情報**: 現在の作業状態

### 4.3 API設計
```python
class MainWindow:
    def load_frame(self, frame_index: int) -> None
    def add_bbox(self, bbox: BoundingBox) -> None
    def update_bbox(self, bbox_id: str, bbox: BoundingBox) -> None
    def delete_bbox(self, bbox_id: str) -> None
    def set_individual_id(self, bbox_id: str, individual_id: int) -> None
    def set_action_id(self, bbox_id: str, action_id: int) -> None
    
class FrameViewer:
    def display_frame(self, image: np.ndarray) -> None
    def set_zoom(self, zoom_factor: float) -> None
    def add_overlay(self, overlay: UIOverlay) -> None
    
class BBoxEditor:
    def create_bbox(self, start_point: Point, end_point: Point) -> str
    def resize_bbox(self, bbox_id: str, new_bounds: Rectangle) -> None
    def move_bbox(self, bbox_id: str, offset: Point) -> None
```

## 5. ショートカット定義

### 5.1 基本操作
```
A: 前フレーム
D: 次フレーム
W: BB作成モード
S: 選択BB削除
Ctrl+Z: 操作取り消し
Shift+A: 前の変化フレーム
Shift+D: 次の変化フレーム
```

### 5.2 ID・行動選択
```
数字キー0-9: 個体ID 0-9選択
Ctrl+数字: 個体ID 10-15選択
F1-F5: 行動ID 0-4選択
Tab: ID/行動選択モード切替
Space: BB表示/非表示切替
```

### 5.3 表示制御
```
+/-: ズームイン/アウト
Ctrl+0: ズームリセット
F11: フルスクリーン切替
Esc: 選択解除
```

## 6. エラーハンドリング

### 6.1 UI エラー
- **描画エラー**: 画像データ不正時の代替表示
- **操作エラー**: 無効な操作の防止とメッセージ表示
- **リソース不足**: メモリ不足時のグレースフルデグラデーション

### 6.2 データエラー
- **不正BB**: 画面外BB の自動修正
- **重複ID**: 同一フレーム内重複IDの警告
- **データ不整合**: 表示データと内部データの同期

## 7. テスト要件

### 7.1 ユニットテスト
- **UI コンポーネント**: 各コンポーネントの単体テスト
- **イベント処理**: マウス・キーボードイベントテスト
- **描画機能**: BB描画の正確性テスト

### 7.2 統合テスト
- **モジュール間**: 他モジュールとの連携テスト
- **パフォーマンス**: 応答時間・描画速度テスト
- **ユーザビリティ**: 実際の使用シナリオテスト